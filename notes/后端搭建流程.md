
# 创建Nest项目
```markdown
nest new backend -s -g -p pnpm
```
# 安装所需依赖
```markdown
pnpm i @nestjs/config @nestjs/jwt @nestjs/passport passport passport-jwt bcrypt prisma @prisma/client redis ioredis
```

- `@nestjs/jwt` + `passport-jwt`用于JWT登录认证
- `bcrypt` 密码加密
- `prisma` + `@prisma/client` 数据库ORM
- `redis` + `ioredis` 缓存

# docker启动服务

> 定义docker-compose.yml

```yaml
version: "3.8" # 指定docker-compose的版本
services: 
  # 数据库
  db: 
    image: mysql:8 # 使用官方mysql8的镜像
    container_name: blog # 容器名称
    restart: always # 容器异常退出时自动重启
    # 配置MYSQL环境变量
    environment:
      MYSQL_ROOT_PASSWORD: 123456 # root用户密码
      MYSQL_DATABASE: blog-mysql # 容器启动时自动创建数据库blog
      # MYSQL_USER: bloguser # 普通用户
      # MYSQL_PASSWORD: blogpass # 普通用户密码
    ports:
      - "3306:3306" # 把容器的3306端口映射到本机的3306端口
    # 数据持久化.把MYSQL数据存储到宿主机,避免容器删掉后数据丢失
    volumes:
      - blog-mysql-data:/var/lib/mysql

  # redis
  redis:
    image: redis:7 # 使用官方redis7镜像
    container_name: blog-redis # 容器名称
    ports:
      - "6379:6379" # 把容器的6379端口映射到本机的6379端口

volumes:
  blog-mysql-data: # 卷, 用于MYSQL数据持久化
```

> 执行docker-compose up -d

# 集成prisma

## 1.手动初始化prisma

```markdown
npx prisma init
```
> 执行后,会在根目录生成prisma文件夹,文件夹中存在`schema.prisma`数据库schema定义文件. 生成的目录结构如下:

```markdown
backend/
 ├─ prisma/
 │   └─ schema.prisma   # 数据库 schema 定义文件
 └─ .env                # 数据库连接配置
```

## 2.配置数据库连接

> 修改.env环境文件

```js
DATABASE_URL="mysql://root:123456@127.0.0.1:3306/blog-mysql"
```

- `root` 你mysql的用户名
- `123456` mysql密码
- `127.0.0.1:3306`你docker暴露的端口
- `blog-mysql` 数据库名

## 3.定义用户模型

```mysql
// prisma/schame.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

## 4.迁移数据库

```markdown
npx prisma migrate dev --name init // 执行后会在数据库中创建User表.
```

## 5.在Nest中集成Prisma

> 首先需要 `PrismaClient`需要先执行 npx prisma generate后, node_module里才会生成, schame每变动一次都要重新生成一次.

```ts
import { Injectable, OnModuleInit, OnModuleDestroy } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';

@Injectable()
export class PrismaService
  extends PrismaClient
  implements OnModuleInit, OnModuleDestroy
{
  async onModuleInit() {
    await this.$connect();
  }

  async onModuleDestroy() {
    await this.$disconnect();
  }
}
```

## 6.AppModule里引入

```ts
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { PrismaService } from 'prisma/prisma.service';

@Module({
  imports: [],
  controllers: [AppController],
  providers: [AppService, PrismaService],
  exports: [PrismaService],
})
export class AppModule {}
```

## 7.运行项目

> pnpm run start:dev即可.